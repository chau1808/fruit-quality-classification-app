import React, { useEffect, useMemo, useRef, useState } from "react";
import "./App.css";
import { motion, AnimatePresence } from "framer-motion";

const API_URL = process.env.REACT_APP_API_URL || "http://127.0.0.1:5000";

function useDarkMode() {
  const prefersDark = window.matchMedia?.("(prefers-color-scheme: dark)")?.matches;
  const [dark, setDark] = useState(() => {
    const saved = localStorage.getItem("theme-dark");
    return saved ? saved === "1" : !!prefersDark;
  });
  useEffect(() => {
    document.documentElement.dataset.theme = dark ? "dark" : "light";
    localStorage.setItem("theme-dark", dark ? "1" : "0");
  }, [dark]);
  return [dark, setDark];
}

function ConfidenceTable({ scores }) {
  const rows = useMemo(() => {
    try {
      if (!scores) return [];
      return Object.entries(scores)
        .map(([k, v]) => [k, Number(v)])
        .sort((a, b) => b[1] - a[1]);
    } catch {
      return [];
    }
  }, [scores]);

  if (!rows.length) return null;

  return (
    <div className="card section">
      <h4 className="section-title">üîé Confidence chi ti·∫øt</h4>
      <div className="conf-grid conf-header">
        <div>L·ªõp</div>
        <div>ƒê·ªô tin c·∫≠y</div>
      </div>
      {rows.map(([label, pct]) => (
        <div className="conf-grid" key={label}>
          <div>{label}</div>
          <div>{pct.toFixed(2)}%</div>
        </div>
      ))}
    </div>
  );
}

function MetaPanel({ meta }) {
  if (!meta) return null;
  return (
    <div className="card section">
      <h4 className="section-title">‚ÑπÔ∏è Th√¥ng tin suy lu·∫≠n</h4>
      <div className="meta-row">
        <span className="meta-k">‚è±Ô∏è Inference</span>
        <span className="meta-v">{meta.inferenceMs ?? "‚Äî"} ms</span>
      </div>
      <div className="meta-row">
        <span className="meta-k">üß† Model</span>
        <span className="meta-v">
          {meta.model?.arch ?? "‚Äî"} <span className="pill">v{meta.model?.version ?? "‚Äî"}</span>
        </span>
      </div>
      <div className="meta-row">
        <span className="meta-k">üì∑ ·∫¢nh</span>
        <span className="meta-v">
          {meta.input?.original_size?.w ?? "‚Äî"}√ó{meta.input?.original_size?.h ?? "‚Äî"} ‚Üí <em>224√ó224</em>
        </span>
      </div>
      {meta.threshold && (
        <div className={`threshold ${meta.threshold.met ? "ok" : "warn"}`}>
          Ng∆∞·ª°ng {meta.threshold.value_pct}% ¬∑ {meta.threshold.met ? "ƒê·∫°t" : "Ch∆∞a ƒë·∫°t"}
          {!meta.threshold.met && meta.threshold.note ? ` ‚Äî ${meta.threshold.note}` : ""}
        </div>
      )}
      {meta.topk?.length > 1 && (
        <div className="conf-table">
          <div className="conf-grid conf-header">
            <div>üèÖ Top-K</div>
            <div>ƒê·ªô tin c·∫≠y</div>
          </div>
          {meta.topk.map(({ class: label, pct }) => (
            <div className="conf-grid" key={label}>
              <div>{label}</div>
              <div>{Number(pct).toFixed(2)}%</div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

function ProgressBar({ show }) {
  return (
    <div className={`progress-wrap ${show ? "show" : ""}`}>
      <div className="progress-bar" />
    </div>
  );
}

function SkeletonCard() {
  return (
    <div className="card section skeleton">
      <div className="sk-title" />
      <div className="sk-line" />
      <div className="sk-line wide" />
      <div className="sk-line" />
    </div>
  );
}

function App() {
  const [dark, setDark] = useDarkMode();

  const [image, setImage] = useState(null);
  const [preview, setPreview] = useState(null);         // ·∫£nh g·ªëc (local)
  const [procPreview, setProcPreview] = useState(null); // ·∫£nh 224x224 t·ª´ backend
  const [result, setResult] = useState("");
  const [scores, setScores] = useState(null);
  const [meta, setMeta] = useState(null);
  const [loading, setLoading] = useState(false);
  const [cameraOn, setCameraOn] = useState(false);
  const [dragOver, setDragOver] = useState(false);
  const [toast, setToast] = useState(null);

  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);

  useEffect(() => {
    return () => {
      if (preview) URL.revokeObjectURL(preview);
      stopCamera();
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    return () => {
      if (preview) URL.revokeObjectURL(preview);
    };
  }, [preview]);

  const showToast = (msg, t = 2500) => {
    setToast(msg);
    setTimeout(() => setToast(null), t);
  };

  const onPickFile = () => fileInputRef.current?.click();

  const handleFile = (file) => {
    if (!file) return;
    if (!file.type.startsWith("image/")) {
      showToast("File ph·∫£i l√† ·∫£nh (jpg/png/webp...)");
      return;
    }
    if (preview) URL.revokeObjectURL(preview);
    setImage(file);
    setPreview(URL.createObjectURL(file));
    setProcPreview(null); // reset preview 224 khi ch·ªçn ·∫£nh m·ªõi
    setResult("");
    setScores(null);
    setMeta(null);
  };

  const handleFileChange = (e) => handleFile(e.target.files?.[0]);

  const onDrop = (e) => {
    e.preventDefault();
    setDragOver(false);
    handleFile(e.dataTransfer.files?.[0]);
  };

  const handleUpload = async () => {
    if (!image) {
      showToast("Vui l√≤ng ch·ªçn ho·∫∑c k√©o-th·∫£ m·ªôt ·∫£nh!");
      return;
    }
    setLoading(true);
    setScores(null);
    setMeta(null);
    setProcPreview(null);

    const formData = new FormData();
    formData.append("file", image);

    try {
      const res = await fetch(`${API_URL}/predict`, { method: "POST", body: formData });
      const data = await res.json();

      if (res.ok && (data.success || data.prediction)) {
        const className = data.prediction?.class || data.class || "unknown";
        const rawPct = data.prediction?.pct ?? data.confidence ?? 0;
        const pct = Number(rawPct <= 1 ? rawPct * 100 : rawPct);

        setResult(`${className.toUpperCase()} (${pct.toFixed(1)}%)`);
        setScores(data.confidence_scores || null);
        setMeta({
          inferenceMs: data.timings?.inference_ms || data.inference_time,
          model: data.model || (data.model_version ? { arch: "vgg16", version: data.model_version } : null),
          input: data.input || (data.original_size ? { original_size: data.original_size } : null),
          threshold: data.threshold,
          topk: data.top_k || [],
        });

        // üëâ l·∫•y ·∫£nh 224√ó224 t·ª´ backend (data.preview l√† data:image/png;base64,...)
        setProcPreview(data.preview || null);
      } else {
        setResult(data.error || "Kh√¥ng nh·∫≠n d·∫°ng ƒë∆∞·ª£c");
      }
    } catch (err) {
      console.error(err);
      setResult("ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi server");
    } finally {
      setLoading(false);
    }
  };

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false,
      });
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        setCameraOn(true);
        showToast("ƒêang s·ª≠ d·ª•ng camera sau (n·∫øu c√≥).");
      }
    } catch (err) {
      console.error("Camera error:", err);
      showToast("Kh√¥ng th·ªÉ m·ªü camera. H√£y c·∫•p quy·ªÅn.");
    }
  };

  const stopCamera = () => {
    if (videoRef.current && videoRef.current.srcObject) {
      const tracks = videoRef.current.srcObject.getTracks();
      tracks.forEach((t) => t.stop());
      videoRef.current.srcObject = null;
    }
    setCameraOn(false);
  };

  const captureImage = () => {
    const video = videoRef.current;
    const canvas = canvasRef.current;
    if (!video || !canvas) return;
    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    ctx.drawImage(video, 0, 0, 224, 224);
    canvas.toBlob(
      (blob) => {
        if (blob) {
          const file = new File([blob], "camera.jpg", { type: "image/jpeg" });
          if (preview) URL.revokeObjectURL(preview);
          setImage(file);
          setPreview(URL.createObjectURL(file));
          setProcPreview(null);
          setResult("");
          setScores(null);
          setMeta(null);
        }
      },
      "image/jpeg",
      0.95
    );
  };

  return (
    <div className="shell">
      <ProgressBar show={loading} />

      <motion.div
        className="app-container"
        initial={{ opacity: 0, y: 12 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.45 }}
      >
        <header className="header">
          <div className="brand">
            <span className="logo">üçç</span>
            <h1>Fruit Quality Classifier</h1>
            <span className="beta">VGG16</span>
          </div>
          <div className="actions">
            <button className="ghost" onClick={() => setDark((d) => !d)}>
              {dark ? "üåô" : "‚òÄÔ∏è"}
            </button>
          </div>
        </header>

        <p className="subtitle">ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng tr√°i c√¢y b·∫±ng AI ¬∑ Flask API @ <span className="link">{API_URL}</span></p>

        {/* Upload & DnD */}
        <div
          className={`dnd ${dragOver ? "over" : ""}`}
          onDragOver={(e) => {
            e.preventDefault();
            setDragOver(true);
          }}
          onDragLeave={() => setDragOver(false)}
          onDrop={onDrop}
        >
          <div className="dnd-inner">
            <div className="dnd-icon">‚¨ÜÔ∏è</div>
            <div className="dnd-title">K√©o-th·∫£ ·∫£nh v√†o ƒë√¢y</div>
            <div className="dnd-sub">ho·∫∑c</div>
            <button className="btn" onClick={onPickFile}>Ch·ªçn file ·∫£nh</button>
            <input ref={fileInputRef} type="file" accept="image/*" hidden onChange={handleFileChange} />
          </div>
        </div>

        <div className="toolbar">
          {!cameraOn ? (
            <button className="btn secondary" onClick={startCamera}>üé• S·ª≠ d·ª•ng camera</button>
          ) : (
            <button className="btn danger" onClick={stopCamera}>‚õî T·∫Øt camera</button>
          )}
          <button className="btn primary" onClick={handleUpload} disabled={loading || !image}>
            {loading ? "üîÑ ƒêang x·ª≠ l√Ω..." : "üîç Ph√¢n lo·∫°i"}
          </button>
          {cameraOn && (
            <button className="btn accent" onClick={captureImage}>üì∏ Ch·ª•p ·∫£nh</button>
          )}
        </div>

        <AnimatePresence>
          {cameraOn && (
            <motion.div
              className="camera card"
              initial={{ scale: 0.98, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ opacity: 0 }}
            >
              <video ref={videoRef} autoPlay width="320" height="240" />
              <canvas ref={canvasRef} width="224" height="224" style={{ display: "none" }} />
            </motion.div>
          )}
        </AnimatePresence>

        <div className="grid">
          <div className="col">
            {preview ? (
              <div className="card image-card">
                <h3>üñºÔ∏è ·∫¢nh ƒë√£ ch·ªçn</h3>
                <img src={preview} alt="Xem tr∆∞·ªõc" />
              </div>
            ) : (
              <SkeletonCard />
            )}

            {/* ·∫¢nh 224x224 t·ª´ backend */}
            {procPreview && (
              <div className="card image-card" style={{ marginTop: 12 }}>
                <h3>üß™ ·∫¢nh 224√ó224 (ƒë∆∞a v√†o model)</h3>
                <img src={procPreview} alt="Processed 224x224" />
              </div>
            )}

            {result && (
              <div className={`card result-card ${loading ? "loading" : ""}`}>
                <div className="result-line">
                  <span className="badge">K·∫øt qu·∫£</span>
                  <span className="result-text">{result}</span>
                </div>
              </div>
            )}
          </div>

          <div className="col">
            {loading ? (
              <>
                <SkeletonCard />
                <SkeletonCard />
              </>
            ) : (
              <>
                <ConfidenceTable scores={scores} />
                <MetaPanel meta={meta} />
              </>
            )}
          </div>
        </div>

        <footer className="footer">
          <div>üå± VGG16 + Transfer Learning ¬∑ X·ª≠ l√Ω c·ª•c b·ªô</div>
          <div>üõ†Ô∏è React ¬∑ Framer Motion ¬∑ Flask</div>
        </footer>
      </motion.div>

      <AnimatePresence>
        {toast && (
          <motion.div
            className="toast"
            initial={{ y: 16, opacity: 0 }}
            animate={{ y: 0, opacity: 1 }}
            exit={{ opacity: 0 }}
          >
            {toast}
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

export default App;
